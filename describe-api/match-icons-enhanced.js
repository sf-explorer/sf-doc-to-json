import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const INDEX_PATH = path.join(__dirname, '../doc/index.json');

// Comprehensive keyword patterns (prioritized - check in order)
const KEYWORD_PATTERNS = {
  // Specific patterns first
  'forecast': 'standard:forecasts',
  'scoring': 'standard:people_score',
  'score': 'standard:people_score',
  'enrollment': 'standard:enrollee_status',
  'enrollee': 'standard:enrollee_status',
  'academic': 'standard:education',
  'education': 'standard:education',
  'learning': 'standard:education',
  'course': 'standard:education',
  'student': 'standard:person_account',
  'appointment': 'standard:service_appointment',
  'schedule': 'standard:schedule_objective',
  'calendar': 'standard:event',
  'event': 'standard:event',
  'meeting': 'standard:event',
  'conference': 'standard:event',
  'email': 'standard:email',
  'message': 'standard:email',
  'chatter': 'standard:feed',
  'feed': 'standard:feed',
  'conversation': 'standard:live_chat',
  'chat': 'standard:live_chat',
  'call': 'standard:call',
  'phone': 'standard:call',
  'voice': 'standard:call',
  'template': 'standard:template',
  'campaign': 'standard:campaign',
  'marketing': 'standard:campaign',
  'claim': 'standard:file',
  'coverage': 'standard:contract',
  'benefit': 'standard:reward',
  'reward': 'standard:reward',
  'disbursement': 'standard:reward',
  'payment': 'standard:payment_gateway',
  'transaction': 'standard:record',
  'invoice': 'standard:orders',
  'order': 'standard:orders',
  'quote': 'standard:quotes',
  'contract': 'standard:contract',
  'agreement': 'standard:contract',
  'policy': 'standard:policy',
  'product': 'standard:product',
  'price': 'standard:pricebooks',
  'cart': 'standard:webcart',
  'shipment': 'standard:shipment',
  'delivery': 'standard:shipment',
  'asset': 'standard:asset_object',
  'resource': 'standard:service_resource',
  'service': 'standard:service_contract',
  'work': 'standard:work_order',
  'shift': 'standard:shift',
  'location': 'standard:location',
  'address': 'standard:address',
  'domain': 'standard:custom_notification',
  'site': 'standard:portal',
  'portal': 'standard:portal',
  'community': 'standard:portal',
  'experience': 'standard:portal',
  'survey': 'standard:survey',
  'feedback': 'standard:feedback',
  'assessment': 'standard:endorsement',
  'examination': 'standard:endorsement',
  'competency': 'standard:skill',
  'skill': 'standard:skill',
  'certification': 'standard:endorsement',
  'license': 'standard:approval',
  'authorization': 'standard:approval',
  'approval': 'standard:approval',
  'permission': 'standard:approval',
  'application': 'standard:app',
  'applicant': 'standard:person_account',
  'recommendation': 'standard:endorsement',
  'review': 'standard:approval',
  'insight': 'standard:insights',
  'metric': 'standard:metric',
  'measure': 'standard:metric',
  'analytics': 'standard:tableau',
  'dashboard': 'standard:dashboard',
  'report': 'standard:report',
  'visualization': 'standard:visualization',
  'widget': 'standard:dashboard_component',
  'component': 'standard:lightning_component',
  'aura': 'standard:lightning_component',
  'budget': 'standard:budget',
  'plan': 'standard:capacity_plan',
  'program': 'standard:program_detail',
  'project': 'standard:work_plan',
  'goal': 'standard:goals',
  'target': 'standard:goals',
  'commitment': 'standard:goals',
  'rule': 'standard:rules',
  'filter': 'standard:filter',
  'criteria': 'standard:filter_criteria',
  'condition': 'standard:filter_criteria',
  'definition': 'standard:entity',
  'config': 'utility:settings',
  'setting': 'utility:settings',
  'setup': 'utility:settings',
  'parameter': 'standard:variable',
  'variable': 'standard:variable',
  'attribute': 'standard:record',
  'field': 'standard:record',
  'record': 'standard:record',
  'data': 'standard:data_integration_hub',
  'batch': 'standard:process',
  'job': 'standard:process',
  'process': 'standard:process',
  'flow': 'standard:flow',
  'automation': 'utility:automate',
  'action': 'standard:action_list_component',
  'trigger': 'standard:apex',
  'apex': 'standard:apex',
  'code': 'standard:apex',
  'debug': 'standard:logging',
  'log': 'standard:logging',
  'error': 'utility:error',
  'exception': 'utility:error',
  'validation': 'standard:approval',
  'duplicate': 'standard:merge',
  'sync': 'standard:data_integration_hub',
  'integration': 'standard:data_integration_hub',
  'external': 'standard:link',
  'credential': 'utility:identity',
  'authentication': 'utility:identity',
  'auth': 'utility:identity',
  'session': 'standard:agent_session',
  'user': 'standard:user',
  'contact': 'standard:contact',
  'person': 'standard:person_account',
  'account': 'standard:account',
  'lead': 'standard:lead',
  'opportunity': 'standard:opportunity',
  'case': 'standard:case',
  'task': 'standard:task',
  'file': 'standard:file',
  'document': 'standard:document',
  'note': 'standard:note',
  'attachment': 'standard:file',
  'media': 'standard:video',
  'image': 'standard:photo',
  'video': 'standard:video',
  'archive': 'utility:archive',
  'history': 'standard:history',
  'change': 'standard:changes',
  'version': 'standard:registered_model',
  'release': 'standard:activation_target',
  'deploy': 'standard:deployment',
  'package': 'standard:bundle_config',
  'bundle': 'standard:bundle_config',
  'group': 'standard:groups',
  'team': 'standard:groups',
  'member': 'standard:people',
  'participant': 'standard:people',
  'attendee': 'standard:assigned_resource',
  'invitee': 'standard:assigned_resource',
  'relation': 'standard:relationship',
  'hierarchy': 'standard:hierarchy',
  'parent': 'standard:hierarchy',
  'child': 'standard:hierarchy',
  'junction': 'standard:link',
  'lookup': 'standard:lookup',
  'reference': 'standard:link',
  'bookmark': 'utility:bookmark',
  'favorite': 'utility:favorite',
  'tag': 'standard:topic',
  'topic': 'standard:topic',
  'category': 'standard:topic',
  'type': 'standard:entity',
  'status': 'standard:entity',
  'stage': 'standard:entity',
  'phase': 'standard:entity',
  'step': 'standard:steps',
  'milestone': 'standard:goals',
  'outcome': 'standard:goals',
  'result': 'standard:outcome',
  'summary': 'standard:record',
  'total': 'standard:metrics',
  'usage': 'standard:metrics',
  'activity': 'standard:recent',
  'tracking': 'standard:logging',
  'monitor': 'standard:logging',
  'alert': 'standard:announcement',
  'notification': 'standard:announcement',
  'reminder': 'utility:reminder',
  'announcement': 'standard:announcement',
  'broadcast': 'standard:announcement',
  'communication': 'standard:email',
  'subscription': 'standard:person_name',
  'consent': 'standard:approval',
  'privacy': 'utility:lock',
  'security': 'utility:lock',
  'encryption': 'utility:lock',
  'compliance': 'standard:approval',
  'audit': 'standard:logging',
  'risk': 'standard:risk',
  'issue': 'standard:case',
  'problem': 'standard:case',
  'complaint': 'standard:case',
  'incident': 'standard:case',
  'crisis': 'standard:announcement',
  'emergency': 'standard:announcement',
  'health': 'standard:patient_service',
  'clinical': 'standard:patient_service',
  'medical': 'standard:patient_service',
  'patient': 'standard:patient_service',
  'practitioner': 'standard:practitioner_role',
  'provider': 'standard:practitioner_role',
  'care': 'standard:care_program_enrollment',
  'diagnosis': 'standard:patient_service',
  'prescription': 'standard:patient_service',
  'medication': 'standard:patient_service',
  'treatment': 'standard:patient_service',
  'procedure': 'standard:patient_service',
  'emissions': 'utility:water',
  'carbon': 'utility:water',
  'energy': 'standard:energy_manager',
  'sustainability': 'utility:water',
  'environmental': 'utility:water',
  'climate': 'utility:water',
  'biodiversity': 'utility:water',
  'renewable': 'standard:energy_manager',
  'waste': 'utility:water',
  'recycling': 'utility:water',
  'loan': 'standard:account',
  'mortgage': 'standard:account',
  'banking': 'standard:account',
  'financial': 'standard:account',
  'investment': 'standard:account',
  'portfolio': 'standard:account',
  'securities': 'standard:account',
  'revenue': 'standard:money',
  'commission': 'standard:money',
  'fee': 'standard:money',
  'charge': 'standard:money',
  'refund': 'standard:money',
  'credit': 'standard:money',
  'debit': 'standard:money',
  'balance': 'standard:money',
  'tax': 'standard:tax_policy',
  'ai': 'standard:bot',
  'bot': 'standard:bot',
  'model': 'standard:no_code_model',
  'algorithm': 'standard:no_code_model',
  'signal': 'standard:signal',
  'sentiment': 'standard:sentiment',
  'engagement': 'standard:people',
  'channel': 'standard:channel_programs',
  'audience': 'standard:people',
  'segment': 'standard:list_email',
  'list': 'standard:list_email',
  'enablement': 'standard:coaching',
  'training': 'standard:coaching',
  'coaching': 'standard:coaching',
  'performance': 'standard:metric',
  'capacity': 'standard:capacity_plan',
  'territory': 'standard:service_territory',
  'region': 'standard:location',
  'zone': 'standard:location',
  'division': 'standard:business_unit',
  'unit': 'standard:business_unit',
  'organization': 'standard:business_unit',
  'department': 'standard:business_unit',
  'custom': 'standard:custom',
  'label': 'standard:text_template',
  'translation': 'standard:language',
  'localization': 'standard:language',
  'color': 'utility:palette',
  'layout': 'standard:page',
  'compact': 'standard:page',
  'tab': 'standard:custom_notification',
  'button': 'standard:custom_notification',
  'link': 'standard:link',
  'url': 'standard:link',
  'page': 'standard:page',
  'form': 'standard:form',
  'wizard': 'standard:form',
  'request': 'standard:task',
  'response': 'standard:outcome',
  'answer': 'standard:answer_public',
  'question': 'standard:question_feed',
  'idea': 'standard:endorsement',
  'solution': 'standard:solution',
  'article': 'standard:article',
  'knowledge': 'standard:knowledge',
  'content': 'standard:content',
  'library': 'standard:custom_component',
  'catalog': 'standard:product',
  'inventory': 'standard:product_item',
  'stock': 'standard:product_item',
  'warehouse': 'standard:location',
  'supplier': 'standard:account',
  'vendor': 'standard:account',
  'partner': 'standard:partner',
  'distributor': 'standard:partner',
  'reseller': 'standard:partner',
  'manufacturer': 'standard:factory',
  'factory': 'standard:factory',
  'building': 'standard:location',
  'facility': 'standard:location',
  'premise': 'standard:location',
  'property': 'standard:asset_object',
  'real estate': 'standard:asset_object',
  'vehicle': 'standard:asset_object',
  'equipment': 'standard:asset_object',
  'device': 'standard:connected_apps',
  'iot': 'standard:connected_apps',
  'sensor': 'standard:connected_apps',
  'meter': 'standard:metrics',
  'reading': 'standard:metric',
  'utility': 'standard:energy_manager',
  'electricity': 'standard:energy_manager',
  'gas': 'standard:energy_manager',
  'water': 'utility:water',
  'loyalty': 'standard:reward',
  'points': 'standard:reward',
  'voucher': 'standard:discounts',
  'promotion': 'standard:manual_discounts',
  'discount': 'standard:manual_discounts',
  'adjustment': 'standard:price_adjustment_schedule',
  'modifier': 'standard:price_adjustment_schedule',
  'tier': 'standard:hierarchy',
  'level': 'standard:hierarchy',
  'rank': 'standard:hierarchy',
  'priority': 'standard:filter_criteria',
  'severity': 'standard:filter_criteria',
  'urgency': 'standard:filter_criteria',
  'sla': 'standard:service_contract',
  'entitlement': 'standard:entitlement',
  'warranty': 'standard:contract',
  'guarantee': 'standard:contract',
  'insurance': 'standard:contract',
  'underwriting': 'standard:approval',
  'premium': 'standard:money',
  'deductible': 'standard:money',
  'copay': 'standard:money',
  'reserve': 'standard:money',
  'recovery': 'standard:money',
  'payout': 'standard:money',
  'reimbursement': 'standard:money',
  'subrogation': 'standard:money',
  'salvage': 'standard:money',
  'adjudication': 'standard:approval',
};

// Cloud-based fallbacks
const CLOUD_FALLBACKS = {
  'Health Cloud': 'standard:patient_service',
  'Financial Services Cloud': 'standard:account',
  'Education Cloud': 'standard:education',
  'Service Cloud': 'standard:service_contract',
  'Sales Cloud': 'standard:opportunity',
  'Commerce Cloud': 'standard:store',
  'Marketing Cloud': 'standard:campaign',
  'Experience Cloud': 'standard:portal',
  'Net Zero Cloud': 'utility:water',
  'Manufacturing Cloud': 'standard:factory',
  'Public Sector Cloud': 'standard:entity',
  'Nonprofit Cloud': 'standard:people',
  'Loyalty': 'standard:reward',
  'Revenue Lifecycle Management': 'standard:money',
  'Automotive Cloud': 'standard:asset_object',
  'Energy and Utilities Cloud': 'standard:energy_manager',
  'Scheduler': 'standard:service_appointment',
  'Field Service Lightning': 'standard:service_territory',
  'Core Salesforce': 'standard:default',
  'Tooling API': 'standard:apex',
};

function findBestMatch(objectName, cloud, description) {
  const searchText = (objectName + ' ' + (description || '')).toLowerCase();
  
  // Try keyword patterns (already in priority order)
  for (const [keyword, icon] of Object.entries(KEYWORD_PATTERNS)) {
    if (searchText.includes(keyword)) {
      return { icon, source: `keyword:${keyword}` };
    }
  }
  
  // Fall back to cloud
  if (cloud && CLOUD_FALLBACKS[cloud]) {
    return { icon: CLOUD_FALLBACKS[cloud], source: `cloud:${cloud}` };
  }
  
  return null;
}

console.log('ðŸ” Enhanced Icon Matching (Keyword + Cloud Fallback)\n');

const index = JSON.parse(fs.readFileSync(INDEX_PATH, 'utf8'));
const objects = index.objects;

let matched = 0;
let alreadyHad = 0;
let noMatch = 0;

const matchSources = {};

for (const [name, obj] of Object.entries(objects)) {
  if (obj.icon) {
    alreadyHad++;
    continue;
  }
  
  const result = findBestMatch(name, obj.cloud, obj.description);
  
  if (result) {
    obj.icon = result.icon;
    matched++;
    matchSources[result.source] = (matchSources[result.source] || 0) + 1;
  } else {
    noMatch++;
  }
}

// Save updated index
fs.writeFileSync(INDEX_PATH, JSON.stringify(index, null, 2));

console.log('ðŸ“Š Results:\n');
console.log(`   Already had icons: ${alreadyHad}`);
console.log(`   Newly matched:     ${matched}`);
console.log(`   Still missing:     ${noMatch}`);
console.log(`   Total objects:     ${Object.keys(objects).length}`);
console.log(`   Coverage:          ${((alreadyHad + matched) / Object.keys(objects).length * 100).toFixed(1)}%\n`);

if (Object.keys(matchSources).length > 0) {
  console.log('ðŸ“ˆ Match Sources:\n');
  const sortedSources = Object.entries(matchSources).sort((a, b) => b[1] - a[1]);
  sortedSources.slice(0, 20).forEach(([source, count]) => {
    console.log(`   ${source.padEnd(40)} â†’ ${count} matches`);
  });
  console.log();
}

console.log(`âœ… Updated ${INDEX_PATH}\n`);

